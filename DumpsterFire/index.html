<!DOCTYPE html>
<html>
<head>
  <title>DumpsterFire</title>
  <script src="https://aframe.io/releases/0.3.0/aframe.js"></script>
  <!--<script src="https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.min.js"></script>-->
  <script src="https://sdk.altvr.com/libs/altspace.js/2.6.2/altspace.min.js"></script>
</head>
<body>
  <a-scene altspace='fullspace: true'>
    <!-- <a-box></a-box> -->
    <a-entity position='4 0 -54' rotation='0 180 0'>
      <a-entity id='model' position='0 0 0' scale='7 7 7' obj-model='obj: url(Alley.obj)' n-mesh-collider='type: environment; convex: false'></a-entity>

      <a-entity position='0 0 -60' scale='1 1 1' rotation='0 0 0'>
        <a-entity obj-model='obj: url(fence.obj); mtl: url(fence.mtl)'></a-entity>
        <a-plane position='0 1.09 0' scale='8.5 1.9 1' material='src:url(fence.png); repeat: 10 2.5; transparent: true; side: double'></a-plane>
      </a-entity>
      
      <!-- <a-plane position='11.5 10 3' rotation='0 -90 0' scale='16 9 1'></a-plane> -->
      <a-entity position='11.5 10 3' rotation='0 -90 0' scale='12 12 12' n-layout-browser='url: about:blank'></a-entity>

      <a-entity id='target' position='-16 10 2' rotation='0 90 0'></a-entity>
      <!-- <a-entity position='-19 .1 2' rotation='0 -90 0' n-portal='targetEntity: #target'></a-entity> -->

      <a-box position='-13.8 10 2' scale='8.3 .1 10' color='#666' n-box-collider='type: environment'></a-box>

      <a-entity id='roofTarget' position='-13.5 20 7' rotation='0 90 0'></a-entity>
      <!-- <a-entity position='-13.5 10 6.8' rotation='0 180 0' n-portal='targetEntity: #roofTarget'></a-entity> -->

      <!-- <a-entity position='-15.5 16.8 -7.7' rotation='0 0 0' n-portal='targetEntity: #target'></a-entity> -->

      <a-box id='button1' position='-18 1.5 2' scale='.05 .1 .1' color='blue'></a-box>
      <a-box id='button2' position='-13.5 11.5 6.8' scale='.1 .1 .05' color='red'></a-box>
      <a-box id='button3' position='-15.5 18.3 -8.2' scale='.1 .1 .05' color='blue'></a-box>

      <a-plane id='building1Door' position='-16.4 1.8 -33.93' rotation='0 180 0.5' scale='2.3 3 1' src='door.png' transparent='true' altspace-cursor-collider='enabled: false'></a-plane>

      <a-mixin id='dottedStripe' material='src:url(line2.png); repeat: 25 1; transparent: true; opacity: .1' altspace-cursor-collider='enabled: false'></a-mixin>
      <a-mixin id='crossingStripe' scale='2.8 .65 1' material='color: #fff; opacity: .1' altspace-cursor-collider='enabled: false'></a-mixin>

      <a-entity>
        <a-entity id='road1' position='0 .13 -48.235' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='48 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='road2' position='0 .13 -40.84' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='48 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='cross1' position='0 .13 -48.55' rotation='-90 0 0'>
          <a-plane position='26 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -10.5 0' mixin='crossingStripe'></a-plane>

          <a-plane position='-26 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -10.5 0' mixin='crossingStripe'></a-plane>
        </a-entity>
      </a-entity>

      <a-entity rotation='0 90 0' position='9.6 0 0'>
        <a-entity id='road1' position='0 .13 -48.235' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='67 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='road2' position='0 .13 -40.84' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='67 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='cross1' position='0 .13 -48.55' rotation='-90 0 0'>
          <a-plane position='35.5 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -10.5 0' mixin='crossingStripe'></a-plane>

          <a-plane position='-35.5 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -10.5 0' mixin='crossingStripe'></a-plane>
        </a-entity>
      </a-entity>

      <a-entity rotation='0 180 0' position='0 0 -.1'>
        <a-entity id='road1' position='0 .13 -48.235' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='48 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='road2' position='0 .13 -40.84' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='48 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='cross1' position='0 .13 -48.55' rotation='-90 0 0'>
          <a-plane position='26 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='26 -10.5 0' mixin='crossingStripe'></a-plane>

          <a-plane position='-26 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-26 -10.5 0' mixin='crossingStripe'></a-plane>
        </a-entity>
      </a-entity>

      <a-entity rotation='0 270 0' position='-9.6 0 0'>
        <a-entity id='road1' position='0 .13 -48.235' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='67 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='road2' position='0 .13 -40.84' rotation='-90 0 0'>
          <a-plane position='-.6 0 0' scale='67 .1 1' mixin='dottedStripe'></a-plane>
        </a-entity>
        <a-entity id='cross1' position='0 .13 -48.55' rotation='-90 0 0'>
          <a-plane position='35.5 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='35.5 -10.5 0' mixin='crossingStripe'></a-plane>

          <a-plane position='-35.5 2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 .5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -1.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -2.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -3.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -4.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -5.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -6.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -7.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -8.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -9.5 0' mixin='crossingStripe'></a-plane>
          <a-plane position='-35.5 -10.5 0' mixin='crossingStripe'></a-plane>
        </a-entity>
      </a-entity>

      <!-- <a-plane id='road' position='0 .125 -48.235' rotation='-90 0 0' scale='56 6.5 1' opacity='.1'></a-plane> -->
      <!-- <a-plane id='road' position='0 .125 -40.84' rotation='-90 0 0' scale='1 6.5 1' opacity='.2'></a-plane> -->

      <!-- <a-plane position='0 .13 -48.235' rotation='-90 0 0' scale='50 .1 1' material='src:url(line2.png); repeat: 25 1' transparent='true' color='#bbb' altspace-cursor-collider='enabled: false'></a-plane> -->
      <!-- <a-plane position='0 .13 -40.84' rotation='-90 0 0' scale='50 .1 1' material='src:url(line2.png); repeat: 25 1' transparent='true' color='#bbb' altspace-cursor-collider='enabled: false'></a-plane> -->
    </a-entity>

    <a-entity id='roomPortal' position='0 -100 0' n-portal='targetEntity: #target' n-skeleton-parent='part: head'></a-entity>
    <a-entity id='roofPortal' position='0 -100 0' n-portal='targetEntity: #roofTarget' n-skeleton-parent='part: head'></a-entity>
  </a-scene>
  <script>

    model.addEventListener('model-loaded', function(){
      var obj = model.object3D.children[0];
      console.log(obj);
      for (var i = 0; i < obj.children.length; i++) {
        obj.children[i].material = obj.children[i].material.clone();
        switch (obj.children[i].name) {
          case 'road1':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.42, 0, 'LightMap.jpg', 1);
            break;
          case 'road2':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.55, 0, 'LightMap.jpg', 1);
            break;
          case 'road3':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.76, 0, 'LightMap.jpg', 1);
            break;
          case 'road4':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.67, 0, 'LightMap.jpg', 1);
            break;
          case 'road5':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.48, 0, 'LightMap.jpg', 1);
            break;
          case 'road6':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.59, 0, 'LightMap.jpg', 1);
            break;
          case 'road7':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.76, 0, 'LightMap.jpg', 1);
            break;
          case 'road8':
            applyTextures(obj.children[i], 'road.jpg', 35, 50, 0.67, 0, 'LightMap.jpg', 1);
            break;
          case 'roads':
            applyTextures(obj.children[i], 'alley.jpg', 80, 80, 0.5, 0.5, 'LightMap.jpg', 1);
            obj.children[i].material.color.set(new THREE.Color(.5,.5,.5));
            break;

          case 'sidewalk':
            applyTextures(obj.children[i], 'sidewalk.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            break;
          case 'alley':
            applyTextures(obj.children[i], 'alley.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            obj.children[i].material.color.set(new THREE.Color(.5,.5,.5));
            break;

          case 'streetlights':
            applyTextures(obj.children[i], 'streetlights.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            break;
          case 'lights':
            //applyTextures(obj.children[i], 'streetlights.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            obj.children[i].material.color.set(new THREE.Color(.9,.9,.9));
            break;
          case 'trafficPoles':
            applyTextures(obj.children[i], 'pole.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            break;
          case 'pedLights':
            applyTextures(obj.children[i], 'streetlights.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            break;

          case 'stop':
            applyTextures(obj.children[i], 'stop.jpg', 1, 1, 0, 0, '', 1);
            break;
          case 'go':
            applyTextures(obj.children[i], 'go.jpg', 1, 1, 0, 0, '', 1);
            break;

          case 'roofs':
            applyTextures(obj.children[i], 'roof.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            break;
          case 'antennaDark':
            applyTextures(obj.children[i], 'streetlights.jpg', 80, 80, 0, 0, 'LightMap.jpg', 1);
            break;
          case 'antennaLight':
            applyTextures(obj.children[i], 'antennaLight.jpg', 100, 100, 0, 0, 'LightMap.jpg', 1);
            break;
          case 'antennaOrange':
            applyTextures(obj.children[i], 'redRust.jpg', 200, 200, 0, 0, 'LightMap.jpg', 1);
            break;

          case 'building1wall1':
            applyTextures(obj.children[i], 'wall1u.jpg', 21, 21, .265, -.03, 'LightMap.jpg', 1);
            break;
          case 'building1wall2':
            applyTextures(obj.children[i], 'wall1u.jpg', 21, 21, .025, -.045, 'LightMap.jpg', 1);
            break;
          case 'building1wall3':
            applyTextures(obj.children[i], 'wall1.jpg', 21, 21, -.005, -.02, 'LightMap.jpg', 1);
            break;
          case 'building1wall4':
            applyTextures(obj.children[i], 'wall1.jpg', 21, 21, -.01, .035, 'LightMap.jpg', 1);
            break;
          case 'building1ledge':
            applyTextures(obj.children[i], 'ledge.jpg', 100, 100, 0, 0, 'LightMap.jpg', 1);
            break;

          case 'building2wall1':
            applyTextures(obj.children[i], 'wall1r.jpg', 21, 21, 0, 0, 'LightMap.jpg', 1);
            break;
          //case 'building2wall2':
            //applyTextures(obj.children[i], 'wall1l.jpg', 21, 21, .025, -.045, 'LightMap.jpg', 1);
            //break;
          case 'building2wall3':
            applyTextures(obj.children[i], 'wall1r.jpg', 21, 21, -.09, 0, 'LightMap.jpg', 1);
            break;
          case 'building2wall4':
            applyTextures(obj.children[i], 'wall1l.jpg', 21, 21, .02, .1, 'LightMap.jpg', 1);
            break;
          case 'building2wall5':
            applyTextures(obj.children[i], 'wall1u.jpg', 21, 21, 0, .16, 'LightMap.jpg', 1);
            break;
          case 'building2wall6':
            applyTextures(obj.children[i], 'wall1u.jpg', 21, 21, -.05, .032, 'LightMap.jpg', 1);
            break;
          case 'building2ledge':
            applyTextures(obj.children[i], 'ledge.jpg', 100, 100, 0, 0, 'LightMap.jpg', 1);
            break;

          default:
            obj.children[i].material.map = THREE.ImageUtils.loadTexture('LightMap.jpg');
            break;
        }
      }

      function applyTextures(mesh, texture, wrapX, wrapY, offsetX, offsetY, lightmap, i) {
        mesh.material.map = THREE.ImageUtils.loadTexture('textures/' + texture);
        mesh.material.map.wrapS = mesh.material.map.wrapT = THREE.RepeatWrapping;
        mesh.material.map.repeat.set(wrapX, wrapY);
        mesh.material.map.offset.set(offsetX, offsetY);
        mesh.material.lightMap = THREE.ImageUtils.loadTexture(lightmap);
        mesh.material.lightMapIntensity = i;
        mesh.material.color.set(new THREE.Color(1,1,1));
        //mesh.addBehaviors(
           //new altspaceutil.behaviors.NativeComponent('n-mesh-collider', { convex: false, type: 'environment' })
        //);

        console.log(mesh.name, mesh.material);
      }
    });

    button1.addEventListener('mouseup', function(){
      toControlRoom();
    });
    button2.addEventListener('mouseup', function(){
      toRoof();
    });
    button3.addEventListener('mouseup', function(){
      toControlRoom();
    });

    function toControlRoom(){
      roomPortal.setAttribute('position', '0 0 0');
      setTimeout(function(){
        roomPortal.setAttribute('position', '0 -100 0');
      }, 1000);
    }
    function toRoof(){
      roofPortal.setAttribute('position', '0 0 0');
      setTimeout(function(){
        roofPortal.setAttribute('position', '0 -100 0');
      }, 1000);
    }

  </script>
</body>
</html>