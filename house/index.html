<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>House</title>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/r84/build/three.min.js"></script>
  <script src="https://aframe.io/releases/0.3.0/aframe.js"></script>
  <script src="https://sdk.altvr.com/libs/altspace.js/2.6.1/altspace.min.js"></script>
  <!-- <script src="https://cdn.rawgit.com/norybiak/UltimateLoader/v0.4.6/dist/UltimateLoader.min.js"></script> -->
  <script src="cached-model.js"></script>
  <script src="UltimateLoader2.js"></script>
  <script>
    // n-skeleton-parent only works with root meshes at the moment. Since most model loaders use a root
    // container object, we need to collapse the model so that n-skeleton-parent can access the mesh directly.
    AFRAME.registerComponent('collapse-model', {
        init: function () {
            this.el.addEventListener('model-loaded', function () {
                this.el.object3DMap.mesh.updateMatrixWorld();
                var mesh;
                this.el.object3DMap.mesh.traverse(function (obj) {
                    if (!mesh && obj instanceof THREE.Mesh) {
                        mesh = obj;
                    }
                }.bind(this))
                if (mesh) {
                    mesh.scale.copy(mesh.getWorldScale());
                    this.el.setObject3D('mesh', mesh);
                    // setObject3D emits this event in a-frame 0.4.0
                    this.el.emit('object3dset', {
                        type: 'mesh'
                    });
                }
            }.bind(this));
        }
    });

    //-----------------------GRAB OBJECTS------------------

    AFRAME.registerComponent('grab-object', {
      dependencies: ['grab-object-system'],
      schema: {
        mixin: {
          type: 'array'
        },
        parts: {
          type: 'array',
          default: ['left', 'right']
        },
        group: {
          type: 'string',
          default: 'default'
        },
        spawner: {
          type: 'boolean',
          default: 'true'
        }
      },
      init: function() {
        this.isHandInRange = { 'left': false, 'right': false };
        this.isTriggerPressed = { 'left': false, 'right': false };
        this.gamepad = { 'left': null, 'right': null };
        this.grabbedObject = { 'left': null, 'right': null };
        this.grabSystem = this.el.sceneEl.systems['grab-object-system'];
        this.syncSystem = this.el.sceneEl.systems['sync-system'];
        this.syncSetup = false;

        this.el.object3D.addEventListener('jointcollisionenter', (function(event) {
          if(event.detail.joints && event.detail.joints[0]) {
            if(/Left/.test(event.detail.joints[0].name)) this.isHandInRange['left'] = true;
            else if(/Right/.test(event.detail.joints[0].name)) this.isHandInRange['right'] = true;
          }
        }).bind(this));

        this.el.object3D.addEventListener('jointcollisionleave', (function(event) {
          if(event.detail.joints && event.detail.joints[0]) {
            if(/Left/.test(event.detail.joints[0].name)) this.isHandInRange['left'] = false;
            else if(/Right/.test(event.detail.joints[0].name)) this.isHandInRange['right'] = false;
          }
        }).bind(this));

        this.el.object3D.addBehaviors(
          new altspace.utilities.behaviors.JointCollisionEvents({
            jointCubeSize: 0.1,
            joints: [
              ['Hand', 'Left', 0],
              ['Thumb', 'Left', 3],
              ['Index', 'Left', 3],
              ['Middle', 'Left', 3],
              ['Ring', 'Left', 3],
              ['Pinky', 'Left', 3]
            ]
          }),
          new altspace.utilities.behaviors.JointCollisionEvents({
            jointCubeSize: 0.1,
            joints: [
              ['Hand', 'Right', 0],
              ['Thumb', 'Right', 3],
              ['Index', 'Right', 3],
              ['Middle', 'Right', 3],
              ['Ring', 'Right', 3],
              ['Pinky', 'Right', 3]
            ]
          })
        );
      },
      tick: function(time, deltaTime) {
        var gamepads = altspace.getGamepads();
        for(var gamepad of gamepads) {
          if(gamepad.connected && !this.gamepad[gamepad.hand]) this.gamepad[gamepad.hand] = gamepad;
        }

        for(var part of this.data.parts) this.updateHandObject(part);

        if (!this.data.spawner && !this.syncSetup && this.syncSystem.connection != undefined) {
          this.syncSetup = true;
          var pos = this.el.parentEl.object3D.position;
          var y = pos.y;
          this.syncSystem.connection.instance.child('grabObjects').child(this.el.getAttribute('mixin')).on('value', function(data){
            if (data.val()) {
              pos.y = -1000;
            } else {
              pos.y = y;
            }
          });
        }
      },
      updateHandObject: function(hand) {
        var isPrevTriggerPressed = this.isTriggerPressed[hand];
        this.isTriggerPressed[hand] = (this.gamepad[hand] && this.gamepad[hand].connected && this.gamepad[hand].buttons[1].pressed);

        if(this.grabbedObject[hand]) {
          if(!this.isTriggerPressed[hand] && this.el.object3D === this.grabSystem.getGrabbedObject(this.data.group)) {
            this.grabSystem.updateGrabbedObject(this.data.group, null);
            this.syncSystem.removeLast(this.grabbedObject[hand]);
            this.grabbedObject[hand] = null;
            
            if (!this.data.spawner) {
              this.syncSystem.connection.instance.child('grabObjects').child(this.el.getAttribute('mixin')).set(false);
            }
          }
        } else {

          //Check to see if people are allowed to grab said object based off of what the object's group and their player class is
          var grabAllowed = true;

          switch(this.data.group) {
            /*case 'meleeWeapon':
            case 'heavyShield': {
              if(playerClass !== 'berserker') grabAllowed = false;
              break;
            }
            case 'rangedWeapon':
            case 'knife': {
              if(playerClass !== 'assassin') grabAllowed = false;
              break;
            }
            case 'staff':
            case 'wand': {
              if(playerClass !== 'spellcaster') grabAllowed =false;

              break;
            }*/
            default: {
              //Leave empty
              break;
            }
          }


          if(this.isHandInRange[hand] && !this.grabSystem.getGrabbedObject(this.data.group) && (this.isTriggerPressed[hand] && !isPrevTriggerPressed && grabAllowed)) {
            this.grabbedObject[hand] = 'go-' + THREE.Math.generateUUID();
            this.grabSystem.updateGrabbedObject(this.data.group, this.el.object3D);
            this.syncSystem.instantiate(this.data.mixin.join(' ') + ' grab-object-' + ((hand === 'left') ? 'left' : 'right'), this.el.sceneEl, this.el, this.grabbedObject[hand]);
            
            if (!this.data.spawner) {
              this.syncSystem.connection.instance.child('grabObjects').child(this.el.getAttribute('mixin')).set(true);
            }
          }
        }
      }
    });

    //------------------------GRAB OBJECTS SYSTEM--------------

    AFRAME.registerSystem('grab-object-system', {
      init: function() {
        this.grabGroups = {};

        var mixin = document.createElement('a-mixin');
        mixin.setAttribute('id', 'grab-object-left');
        mixin.setAttribute('n-skeleton-parent', 'part: hand; side: left; index: 0');
        mixin.setAttribute('sync', '');
        mixin.setAttribute('sync-n-skeleton-parent', '');
        this.sceneEl.appendChild(mixin);

        var mixin = document.createElement('a-mixin');
        mixin.setAttribute('id', 'grab-object-right');
        mixin.setAttribute('n-skeleton-parent', 'part: hand; side: right; index: 0');
        mixin.setAttribute('sync', '');
        mixin.setAttribute('sync-n-skeleton-parent', '');
        this.sceneEl.appendChild(mixin);
      },
      getGrabbedObject: function(groupName) {
        return this.grabGroups[groupName];
      },
      updateGrabbedObject: function(groupName, object) {
        if(!object) delete this.grabGroups[groupName];
        else this.grabGroups[groupName] = object;
      }
    });

    //----------------Cached Avatar Loader-----------------------

    AFRAME.registerComponent('avatar', {
      schema: {
        sid: {
          type: 'string'
        },
        colors: {
          type: 'src'
        }
      },
      init: function() {
        var self = this;
          
        var models = {
          's-series-m01':  'https://bengarfield.github.io/AltVR/house/avatars/malesmall.obj',
          's-series-f01':  'https://bengarfield.github.io/AltVR/house/avatars/femalesmall.obj',
          'pod-classic':  'https://bengarfield.github.io/AltVR/house/avatars/podclassic.obj',
          'rubenoid-male':  'https://bengarfield.github.io/AltVR/house/avatars/rubemalesmall.obj',
          'rubenoid-female':  'https://bengarfield.github.io/AltVR/house/viv.obj',
          'picture-frame':  'https://bengarfield.github.io/AltVR/house/frame.obj'
        };
        
        var objects = {
          model: {url: models[this.data.sid]},
          tex: {url: this.data.colors}
        };

        UltimateLoader.load(objects).then(function(result){
          var mesh = result[0].children[0].clone();

          mesh.material = mesh.material.clone();
          mesh.material.map = result[1];
          self.el.setObject3D('mesh', mesh);
          self.el.emit('object3dset', {type: 'mesh'});
        });
      }
    });
  </script>
</head>
<body>
  <a-scene altspace='fullspace: true' sync-system='author: BenG; app: Kicker; refUrl: https://altvr-apps.firebaseio.com/' grab-object-system>
    <a-entity position='7.505 1.33 1.465' scale='.55 .55 1' rotation='0 -120 0' n-layout-browser='url: https://video-jukebox.firebaseapp.com/?category=house-party&room=nighthouse'></a-entity>
    <a-entity position='0 3 0 ' n-layout-browser='url: https://bengarfield.github.io/AltVR/codenames3d?altspace-sync-instance=nighthouse&sounds=2&mode=1; isEnclosure: true'></a-entity>
    <a-entity position='0 1 -35' n-layout-browser='isEnclosure: true'></a-entity>
    <!-- <a-entity scale='100 100 100' n-layout-browser='url: http://ravenworks.ca/altspace/sculpTogether/; isEnclosure: true'></a-entity> -->

    <a id='link' href='altspace://account.altvr.com/api/spaces/campfire-lobby'></a>
    <a id='coma' href='altspace://account.altvr.com/api/events/667738242228945250'></a>
    <a id='house' href='altspace://account.altvr.com/api/spaces/experience-space-707549238216622625'></a>
    
    <a-assets>
      <a-mixin id='rightpos' position='-.11 -.15 -.15' rotation='45 0 90'></a-mixin>
      <a-mixin id='leftpos' position='.11 -.15 -.15' rotation='45 0 -90'></a-mixin>

      <a-mixin id='rightav' position='.03 -.03 -.08' rotation='90 0 90'></a-mixin>
      <a-mixin id='leftav' position='-.03 -.03 -.08' rotation='90 0 -90'></a-mixin>

      <a-mixin id='ahole' n-text='fontSize: 5;text: Asshole' position='0 1 0' rotation='0 180 0' n-skeleton-parent='part: spine' sync sync-n-skeleton-parent></a-mixin>
      <a-mixin id='shutup' n-text='fontSize: 5;text: Shut Up!' position='0 1 0' rotation='0 180 0' n-skeleton-parent='part: spine' sync sync-n-skeleton-parent></a-mixin>
    </a-assets>
    
    <a-entity id='panel' position='-17.86 -.31 2.55'>
      <a-box position='8.9 1.8 4.6' scale='.08 .4 1.4' color='#111' altspace-cursor-collider='enabled: false'></a-box>
      <a-box position='8.9 1.5 4.65' scale='.08 .2 .35' color='#111' altspace-cursor-collider='enabled: false'></a-box>
      <a-cylinder id='button' position='8.9 1.5 4.6' rotation='0 0 90' scale='.05 .15 .05' color='#300' n-mesh-collider='type: hologram'></a-cylinder>
      <a-cylinder id='kickbutton' position='8.9 1.5 4.75' rotation='0 0 90' scale='.03 .15 .03' color='#330' n-mesh-collider='type: hologram'></a-cylinder>

      <a-entity id='pooltext' position='8.84 1.88 3' scale='.03 .03 .03' rotation='0 -90 0'></a-entity>
      <a-cylinder id='poolbutton' position='8.9 1.8 3' rotation='0 0 90' scale='.05 .15 .05' color='#300' n-mesh-collider='type: hologram'></a-cylinder>

      <a-entity id='codetext' position='8.84 1.88 3.3' scale='.03 .03 .03' rotation='0 -90 0'></a-entity>
      <a-cylinder id='codebutton' position='8.9 1.8 3.3' rotation='0 0 90' scale='.05 .15 .05' color='#300' n-mesh-collider='type: hologram'></a-cylinder>
      <a-entity id='buttons'></a-entity>
    </a-entity>
    
    <a-entity id='fly'></a-entity>

    <a-plane id='poolcover' scale='10 15 .01' position='5 -.1 14' rotation='-90 0 0' material='visible: false' n-box-collider='type: environment; convex: false'></a-plane>
    <a-box id='roof' scale='2 .7 .8' position='-6.2 6 2.85' rotation='45 0 0' material='visible: false' n-box-collider='type: environment; convex: false'></a-box>
    
    <a-entity id='info' position='-6 1.7 23' rotation='0 180 0'>
      <a-image id='infoImage' position='0 -100 0' scale='5.135 1.8 1' src="https://bengarfield.github.io/AltVR/codenames/vivRules.png" altspace-cursor-collider='enabled: false'></a-image>
      <a-image id='infoImage2' position='0 -100 0' scale='9.117 1.86 1' src="https://bengarfield.github.io/AltVR/codenames/manualsmall.jpg" altspace-cursor-collider='enabled: false'></a-image>
      <a-box id='showInfo' position='-1 -100 0' scale='1 .3 .1' color='red'></a-box>
      <a-box id='showInfo2' position='1 -100 0' scale='1 .3 .1' color='blue'></a-box>
    </a-entity>
    
    <a-entity id='photos' position='8.1 1.105 -.8' rotation='0 -90 0'>
      <a-entity position='-.2 0 0' rotation='-10 -15 0'>
        <a-mixin id="frame1" avatar='sid: picture-frame; colors: url(DC40L50XcAATzSt.jpg)' collapse-model></a-mixin>
        <a-entity mixin="frame1" grab-object="group: r; parts: right; mixin: frame1 rightpos; spawner: false"></a-entity>
        <a-entity mixin="frame1" grab-object="group: l; parts: left; mixin: frame1 leftpos; spawner: false"></a-entity>
      </a-entity>
      
      <a-entity position='-.6 0 -.1' rotation='-10 10 0'>
        <a-mixin id="frame2" avatar='sid: picture-frame; colors: url(DCocduTXkAAZ6kd.jpg)' collapse-model></a-mixin>
        <a-entity mixin="frame2" grab-object="group: r; parts: right; mixin: frame2 rightpos; spawner: false"></a-entity>
        <a-entity mixin="frame2" grab-object="group: l; parts: left; mixin: frame2 leftpos; spawner: false"></a-entity>
      </a-entity>
      
      <a-entity position='.3 0 -.1' rotation='-10 -10 0'>
        <a-mixin id="frame3" avatar='sid: picture-frame; colors: url(DDDLYHQXkAEwrCS.jpg)' collapse-model></a-mixin>
        <a-entity mixin="frame3" grab-object="group: r; parts: right; mixin: frame3 rightpos; spawner: false"></a-entity>
        <a-entity mixin="frame3" grab-object="group: l; parts: left; mixin: frame3 leftpos; spawner: false"></a-entity>
      </a-entity>
      
      <a-entity position='.7 0 0' rotation='-10 -5 0'>
        <a-mixin id="frame4" avatar='sid: picture-frame; colors: url(x1Hx1ph.jpg)' collapse-model></a-mixin>
        <a-entity mixin="frame4" grab-object="group: r; parts: right; mixin: frame4 rightpos; spawner: false"></a-entity>
        <a-entity mixin="frame4" grab-object="group: l; parts: left; mixin: frame4 leftpos; spawner: false"></a-entity>
      </a-entity>
    </a-entity>

    <a-entity position='-1.5 1.45 .1' rotation='0 90 0'>
      <a-mixin id="viv" avatar='sid: rubenoid-female; colors: url(viv.png)' collapse-model></a-mixin>
      <a-entity mixin="viv" grab-object="group: r; parts: right; mixin: viv rightav; spawner: false"></a-entity>
      <a-entity mixin="viv" grab-object="group: l; parts: left; mixin: viv leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.5 1.45 .2' rotation='0 90 0'>
      <a-mixin id="ben" avatar='sid: s-series-m01; colors: url(ben.jpg)' collapse-model></a-mixin>
      <a-entity mixin="ben" grab-object="group: r; parts: right; mixin: ben rightav; spawner: false"></a-entity>
      <a-entity mixin="ben" grab-object="group: l; parts: left; mixin: ben leftav; spawner: false"></a-entity>
    </a-entity>

    <!-- <a-entity position='-1.5 1.45 .4' rotation='0 90 0'>
      <a-mixin id="viv2" cached-obj-model='obj: url(avatars/viv2.obj); mtl: url(avatars/viv2.mtl)' collapse-model></a-mixin>
      <a-entity mixin="viv2" grab-object="group: r; parts: right; mixin: viv2 rightav; spawner: false"></a-entity>
      <a-entity mixin="viv2" grab-object="group: l; parts: left; mixin: viv2 leftav; spawner: false"></a-entity>
    </a-entity> -->

    <a-entity position='7.3 1.02 -6.87' rotation='0 -90 0'>
      <a-mixin id="rocka" avatar='sid: s-series-f01; colors: url(avatars/rocka.png)' collapse-model></a-mixin>
      <a-entity mixin="rocka" grab-object="group: r; parts: right; mixin: rocka rightav; spawner: false"></a-entity>
      <a-entity mixin="rocka" grab-object="group: l; parts: left; mixin: rocka leftav; spawner: false"></a-entity>
    </a-entity>

    <!-- <a-entity position='-4.9 1.91 -3' scale='1 1 1'>
      <a-mixin id="fae" cached-obj-model='obj: url(avatars/femalesmall.obj); mtl: url(avatars/fae.mtl)' collapse-model></a-mixin>
      <a-entity mixin="fae" grab-object="group: r; parts: right; mixin: fae rightav; spawner: false"></a-entity>
      <a-entity mixin="fae" grab-object="group: l; parts: left; mixin: fae leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-4.7 1.91 -3' scale='1 1 1'>
      <a-mixin id="lisa" cached-obj-model='obj: url(avatars/lisa.obj); mtl: url(avatars/lisa.mtl)' collapse-model></a-mixin>
      <a-entity mixin="lisa" grab-object="group: r; parts: right; mixin: lisa rightav; spawner: false"></a-entity>
      <a-entity mixin="lisa" grab-object="group: l; parts: left; mixin: lisa leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-4.5 1.91 -3' scale='1 1 1'>
      <a-mixin id="bruce" cached-obj-model='obj: url(avatars/bruce.obj); mtl: url(avatars/bruce.mtl)' collapse-model></a-mixin>
      <a-entity mixin="bruce" grab-object="group: r; parts: right; mixin: bruce rightav; spawner: false"></a-entity>
      <a-entity mixin="bruce" grab-object="group: l; parts: left; mixin: bruce leftav; spawner: false"></a-entity>
    </a-entity> -->

    <a-entity position='8.2 .95 -.1' rotation='0 -90 0'>
      <a-mixin id="oddity" avatar='sid: s-series-m01; colors: url(avatars/oddity.jpg)' collapse-model></a-mixin>
      <a-entity mixin="oddity" grab-object="group: r; parts: right; mixin: oddity rightav; spawner: false"></a-entity>
      <a-entity mixin="oddity" grab-object="group: l; parts: left; mixin: oddity leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.9 1.95 -4.65' rotation='0 -120 0'>
      <a-mixin id="rez" avatar='sid: s-series-f01; colors: url(avatars/new/Rizalina.jpg)' collapse-model></a-mixin>
      <a-entity mixin="rez" grab-object="group: r; parts: right; mixin: rez rightav; spawner: false"></a-entity>
      <a-entity mixin="rez" grab-object="group: l; parts: left; mixin: rez leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity id='newavs' position='0 0 0'>
    <a-entity position='-7.94 .82 -4.5' rotation='0 0 0'>
      <a-mixin id="auzrea" avatar='sid: s-series-f01; colors: url(avatars/new/Auzrea.jpg)' collapse-model></a-mixin>
      <a-entity mixin="auzrea" grab-object="group: r; parts: right; mixin: auzrea rightav; spawner: false"></a-entity>
      <a-entity mixin="auzrea" grab-object="group: l; parts: left; mixin: auzrea leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='3.35 1.3 -2.63' rotation='0 0 0'>
      <a-mixin id="chris" avatar='sid: s-series-m01; colors: url(avatars/new/Chris.jpg)' collapse-model></a-mixin>
      <a-entity mixin="chris" grab-object="group: r; parts: right; mixin: chris rightav; spawner: false"></a-entity>
      <a-entity mixin="chris" grab-object="group: l; parts: left; mixin: chris leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='6.6 1.3 -2.69' rotation='0 0 0'>
      <a-mixin id="chris2" avatar='sid: pod-classic; colors: url(avatars/new/Chris2.jpg)' collapse-model></a-mixin>
      <a-entity mixin="chris2" grab-object="group: r; parts: right; mixin: chris2 rightav; spawner: false"></a-entity>
      <a-entity mixin="chris2" grab-object="group: l; parts: left; mixin: chris2 leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-6 1.86 -5.8' rotation='0 0 0'>
      <a-mixin id="justjohn" avatar='sid: s-series-m01; colors: url(avatars/new/JustJohn.jpg)' collapse-model></a-mixin>
      <a-entity mixin="justjohn" grab-object="group: r; parts: right; mixin: justjohn rightav; spawner: false"></a-entity>
      <a-entity mixin="justjohn" grab-object="group: l; parts: left; mixin: justjohn leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-.35 1.02 -7.55' rotation='0 0 0'>
      <a-mixin id="megan" avatar='sid: s-series-f01; colors: url(avatars/new/Megan.jpg)' collapse-model></a-mixin>
      <a-entity mixin="megan" grab-object="group: r; parts: right; mixin: megan rightav; spawner: false"></a-entity>
      <a-entity mixin="megan" grab-object="group: l; parts: left; mixin: megan leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='8.2 .84 1.5' rotation='0 -120 0'>
      <a-mixin id="paul" avatar='sid: s-series-m01; colors: url(avatars/new/Paul.jpg)' collapse-model></a-mixin>
      <a-entity mixin="paul" grab-object="group: r; parts: right; mixin: paul rightav; spawner: false"></a-entity>
      <a-entity mixin="paul" grab-object="group: l; parts: left; mixin: paul leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-7.94 .82 -4.4' rotation='0 180 0'>
      <a-mixin id="sandro" avatar='sid: s-series-m01; colors: url(avatars/new/Sandro.jpg)' collapse-model></a-mixin>
      <a-entity mixin="sandro" grab-object="group: r; parts: right; mixin: sandro rightav; spawner: false"></a-entity>
      <a-entity mixin="sandro" grab-object="group: l; parts: left; mixin: sandro leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='5.15 1.02 -8.17' rotation='0 -90 0'>
      <a-mixin id="shannon" avatar='sid: s-series-f01; colors: url(avatars/new/Shannon.jpg)' collapse-model></a-mixin>
      <a-entity mixin="shannon" grab-object="group: r; parts: right; mixin: shannon rightav; spawner: false"></a-entity>
      <a-entity mixin="shannon" grab-object="group: l; parts: left; mixin: shannon leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='8.26 .95 -.55' rotation='0 -90 0'>
      <a-mixin id="tahla" avatar='sid: s-series-f01; colors: url(avatars/new/Tahla.jpg)' collapse-model></a-mixin>
      <a-entity mixin="tahla" grab-object="group: r; parts: right; mixin: tahla rightav; spawner: false"></a-entity>
      <a-entity mixin="tahla" grab-object="group: l; parts: left; mixin: tahla leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-4.2 .8 -21.8' rotation='0 0 0'>
      <a-mixin id="topp" avatar='sid: pod-classic; colors: url(avatars/new/Topp.jpg)' collapse-model></a-mixin>
      <a-entity mixin="topp" grab-object="group: r; parts: right; mixin: topp rightav; spawner: false"></a-entity>
      <a-entity mixin="topp" grab-object="group: l; parts: left; mixin: topp leftav; spawner: false"></a-entity>
    </a-entity>

    <!-- <a-entity position='-4.55 2.23 -3' rotation='0 0 0'>
      <a-mixin id="waco" avatar='sid: s-series-m01; colors: url(avatars/new/Waco.jpg)' collapse-model></a-mixin>
      <a-entity mixin="waco" grab-object="group: r; parts: right; mixin: waco rightav; spawner: false"></a-entity>
      <a-entity mixin="waco" grab-object="group: l; parts: left; mixin: waco leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-4.45 2.23 -3' rotation='0 0 0'>
      <a-mixin id="shoo" avatar='sid: s-series-f01; colors: url(avatars/new/Shoo.jpg)' collapse-model></a-mixin>
      <a-entity mixin="shoo" grab-object="group: r; parts: right; mixin: shoo rightav; spawner: false"></a-entity>
      <a-entity mixin="shoo" grab-object="group: l; parts: left; mixin: shoo leftav; spawner: false"></a-entity>
    </a-entity> -->

    <a-entity position='9.3 2.15 20.85' rotation='0 230 0'>
        <a-mixin id="erock" avatar='sid: s-series-m01; colors: url(avatars/new/Erock.jpg)' collapse-model></a-mixin>
        <a-entity mixin="erock" grab-object="group: r; parts: right; mixin: erock rightav; spawner: false"></a-entity>
        <a-entity mixin="erock" grab-object="group: l; parts: left; mixin: erock leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.4 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="shauna" avatar='sid: s-series-f01; colors: url(avatars/new/Shauna.jpg)' collapse-model></a-mixin>
      <a-entity mixin="shauna" grab-object="group: r; parts: right; mixin: shauna rightav; spawner: false"></a-entity>
      <a-entity mixin="shauna" grab-object="group: l; parts: left; mixin: shauna leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.3 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="kenny" avatar='sid: s-series-m01; colors: url(avatars/new/Kenny.jpg)' collapse-model></a-mixin>
      <a-entity mixin="kenny" grab-object="group: r; parts: right; mixin: kenny rightav; spawner: false"></a-entity>
      <a-entity mixin="kenny" grab-object="group: l; parts: left; mixin: kenny leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.2 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="shipman" avatar='sid: s-series-m01; colors: url(avatars/shipman.jpg)' collapse-model></a-mixin>
      <a-entity mixin="shipman" grab-object="group: r; parts: right; mixin: shipman rightav; spawner: false"></a-entity>
      <a-entity mixin="shipman" grab-object="group: l; parts: left; mixin: shipman leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.1 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="talena" avatar='sid: s-series-f01; colors: url(avatars/talena.jpg)' collapse-model></a-mixin>
      <a-entity mixin="talena" grab-object="group: r; parts: right; mixin: talena rightav; spawner: false"></a-entity>
      <a-entity mixin="talena" grab-object="group: l; parts: left; mixin: talena leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="miyk" avatar='sid: s-series-m01; colors: url(avatars/new/Miyk.jpg)' collapse-model></a-mixin>
      <a-entity mixin="miyk" grab-object="group: r; parts: right; mixin: miyk rightav; spawner: false"></a-entity>
      <a-entity mixin="miyk" grab-object="group: l; parts: left; mixin: miyk leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-.9 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="miykf" avatar='sid: s-series-f01; colors: url(avatars/new/MiykF.jpg)' collapse-model></a-mixin>
      <a-entity mixin="miykf" grab-object="group: r; parts: right; mixin: miykf rightav; spawner: false"></a-entity>
      <a-entity mixin="miykf" grab-object="group: l; parts: left; mixin: miykf leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-.8 1.5 -3.5' rotation='0 0 0'>
      <a-mixin id="ostrog" avatar='sid: s-series-m01; colors: url(avatars/new/Ostrog.jpg)' collapse-model></a-mixin>
      <a-entity mixin="ostrog" grab-object="group: r; parts: right; mixin: ostrog rightav; spawner: false"></a-entity>
      <a-entity mixin="ostrog" grab-object="group: l; parts: left; mixin: ostrog leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.4 1.3 -3.5' rotation='0 0 0'>
      <a-mixin id="tim" avatar='sid: s-series-m01; colors: url(avatars/new/Tim.jpg)' collapse-model></a-mixin>
      <a-entity mixin="tim" grab-object="group: r; parts: right; mixin: tim rightav; spawner: false"></a-entity>
      <a-entity mixin="tim" grab-object="group: l; parts: left; mixin: tim leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.3 1.3 -3.5' rotation='0 0 0'>
      <a-mixin id="poxxxx" avatar='sid: s-series-m01; colors: url(avatars/new/Poxxxx.jpg)' collapse-model></a-mixin>
      <a-entity mixin="poxxxx" grab-object="group: r; parts: right; mixin: poxxxx rightav; spawner: false"></a-entity>
      <a-entity mixin="poxxxx" grab-object="group: l; parts: left; mixin: poxxxx leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.2 1.3 -3.5' rotation='0 0 0'>
      <a-mixin id="daedra" avatar='sid: s-series-m01; colors: url(avatars/new/Daedra.jpg)' collapse-model></a-mixin>
      <a-entity mixin="daedra" grab-object="group: r; parts: right; mixin: daedra rightav; spawner: false"></a-entity>
      <a-entity mixin="daedra" grab-object="group: l; parts: left; mixin: daedra leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1.1 1.3 -3.5' rotation='0 0 0'>
      <a-mixin id="matt" avatar='sid: pod-classic; colors: url(avatars/new/Matt.jpg)' collapse-model></a-mixin>
      <a-entity mixin="matt" grab-object="group: r; parts: right; mixin: matt rightav; spawner: false"></a-entity>
      <a-entity mixin="matt" grab-object="group: l; parts: left; mixin: matt leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-1 1.3 -3.5' rotation='0 0 0'>
      <a-mixin id="vince" avatar='sid: s-series-m01; colors: url(avatars/new/Vince.jpg)' collapse-model></a-mixin>
      <a-entity mixin="vince" grab-object="group: r; parts: right; mixin: vince rightav; spawner: false"></a-entity>
      <a-entity mixin="vince" grab-object="group: l; parts: left; mixin: vince leftav; spawner: false"></a-entity>
    </a-entity>

    <a-entity position='-.9 1.3 -3.5' rotation='0 0 0'>
      <a-mixin id="ann" avatar='sid: s-series-f01; colors: url(avatars/new/Ann.jpg)' collapse-model></a-mixin>
      <a-entity mixin="ann" grab-object="group: r; parts: right; mixin: ann rightav; spawner: false"></a-entity>
      <a-entity mixin="ann" grab-object="group: l; parts: left; mixin: ann leftav; spawner: false"></a-entity>
    </a-entity>
      
<!--     <a-entity position='0 0 0' rotation='0 90 0'>
      <a-mixin id="bigvivian" cached-obj-model='obj: url(https://bengarfield.github.io/AltVR/avatar/Vivian/vivian.obj); mtl: url(https://bengarfield.github.io/AltVR/avatar/Vivian/vivian.mtl)' collapse-model></a-mixin>
      <a-entity mixin="bigvivian" grab-object="group: r; parts: right; mixin: bigvivian rightav; spawner: false"></a-entity>
      <a-entity mixin="bigvivian" grab-object="group: l; parts: left; mixin: bigvivian leftav; spawner: false"></a-entity>
    </a-entity> -->
    </a-entity>

    
    <!-- paintings -->
    
    <a-plane id='painting1' position='-.625 1.515 2.28' scale='.55 1.08 1' rotation='0 180 0' src='1.jpg' altspace-cursor-collider='enabled: false'></a-plane>
    <a-plane id='painting2' position='2.31 -1.456 -3.19' scale='.45 1.045 1' altspace-cursor-collider='enabled: false'></a-plane>
    <a-plane id='painting3' position='4.956 -1.674 -3.188' scale='1.53 .735 1' altspace-cursor-collider='enabled: false'></a-plane>
    
    <a-sphere id='blindSphere' position='0 -1000 0' radius='.2' material='color:black; side: back' n-skeleton-parent='part: head'></a-sphere>

    <a-box id='door' position='4.84 1.1 -8.25' scale='.83 2.2 .05' material='opacity: 0' n-box-collider='type: hologram'></a-box>
    <a-box position='5.3 0 -16' scale='7 .01 15' material='opacity: 0' n-box-collider='type: environment; convex: false'></a-box>
    <a-entity id='target' position='4.84 .5 -9' rotation='0 180 0'></a-entity>
    <a-entity id='doorPortal' position='0 -100 0' rotation='0 180 0' n-portal='targetEntity: #target' n-skeleton-parent='part: head'></a-entity>

  </a-scene>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Chambers -->
  <ins class="adsbygoogle"
       style="display:inline-block;width:300px;height:600px"
       data-ad-client="ca-pub-4104619818447346"
       data-ad-slot="9672427398"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
  <script>
  //altspace.open('http://www.google.com/#q=how+to+play+codenames', '_experience', {icon: 'http://bengarfield.github.io/AltVR/codenames/icon.png', hidden: true});

  door.addEventListener('mouseup', function(){
    doorPortal.setAttribute('position', '0 0 0');
    setTimeout(function(){
      doorPortal.setAttribute('position', '0 -100 0');
    }, 1);
  });

  var scene = document.querySelector('a-scene');
  scene.addEventListener('connected', function() {
    var sync = scene.systems['sync-system'].connection;
    Promise.all([
      altspace.getUser(),
      altspace.getThreeJSTrackingSkeleton(),
    ]).then(function(results){
      var user = results[0];
      var s = results[1];

      if (user.isModerator) {
        //scene.systems['sync-system'].instantiate('leftframe', scene, scene, 'frame1' + user.userId);
        /*for (var i = 0; i < handtest.children.length; i++) {
          handtest.children[i].setAttribute('n-skeleton-parent', 'part: hand; side: left');
        }*/
      }

      if (user.displayName == 'FACEMAN') {
        scene.systems['sync-system'].instantiate('ahole', scene);
      }
      if (user.displayName == 'JustJohn') {
        scene.systems['sync-system'].instantiate('shutup', scene);
      }

      var inControl = false;

      if (user.userId == '582115151281389721' || user.userId == '613349871495152349' || user.userId == '542562301434134702' || user.userId == '635719319472308908') {
        inControl = true;
        altspace.open('http://output.jsbin.com/vezefux?altspace-sync-instance=nighthouse', '_experience', {hidden: true});
        newavs.setAttribute('position', '0 0 0');
      }

      document.querySelector('a-scene').object3D.add(s);

      var players = sync.instance.child('players');
      var you = players.child(user.displayName + user.userId);
      var kick = sync.instance.child('kick');
      var kick2 = sync.instance.child('realkick');

      var showI = sync.instance.child('show');
      var showI2 = sync.instance.child('show2');


      var coverOn = false;
      var syncpool = sync.instance.child('poolcover');
      syncpool.on('value', function(data){
        if (data.val() == null) {
          syncpool.set(false);
        } else {
          if (data.val()) {
            poolbutton.setAttribute('color', '#030');
            poolcover.setAttribute('position', '5 -.1 14');
            coverOn = true;
          } else {
            poolbutton.setAttribute('color', '#300');
            poolcover.setAttribute('position', '5 -10 14');
            coverOn = false;
          }
        }
      });
      
      /*var grabObjects = sync.instance.child('grabObjects');
      grabObjects.on('child_changed', function(childSnapshot, prevChildKey){
        console.log(childSnapshot.key(), childSnapshot.val());
        if (childSnapshot.val()) {
          document.querySelector('#frame' + childSnapshot.key()).parentElement.object3D.position.y = -100;
        } else {
          document.querySelector('#frame' + childSnapshot.key()).parentElement.object3D.position.y = 0;
        }
      });*/

      var realkick = false;

      var playerList = [];
      var playerObj = {};
      var playerIds = [];

      var stay = false;
      var show = false;
      var show2 = false;

      if (user.isModerator) {
        showInfo.object3D.position.y = -1.4;
        showInfo2.object3D.position.y = -1.4;
        showInfo.addEventListener('mouseup', function(){
          show = !show;
          showI.set(show);
        });
        showInfo2.addEventListener('mouseup', function(){
          show2 = !show2;
          showI2.set(show2);
        });
      }

      showI.on('value', function(data){
        if (data.val() != null) {
          show = data.val();
          if (show) {
            infoImage.object3D.position.y = 0;
            showInfo.setAttribute('color', 'green');
            if (show2) {
              showI2.set(false);
            }
          } else {
            infoImage.object3D.position.y = -100;
            showInfo.setAttribute('color', 'red');
          }
        }
      });

      showI2.on('value', function(data){
        if (data.val() != null) {
          show2 = data.val();
          if (show2) {
            infoImage2.object3D.position.y = 0;
            showInfo2.setAttribute('color', 'green');
            if (show) {
              showI.set(false);
            }
          } else {
            infoImage2.object3D.position.y = -100;
            showInfo2.setAttribute('color', 'blue');
          }
        }
      });

      for (var i = 0; i < 27; i++) {
        var y = 1.9;
        var z = 4 + (i * .15);
        if (i > 8) {
          y = 1.8;
          z = 4 + ((i - 9) * .15);
        }
        if (i > 17) {
          y = 1.7;
          z = 4 + ((i - 18) * .15);
        }
        var b = document.createElement('a-cylinder');
        b.setAttribute('id', 'abutton' + i);
        b.setAttribute('position', {x:8.9,y:y - 1000,z:z});
        b.setAttribute('scale', '.025 .15 .025');
        b.setAttribute('rotation', '0 0 90');
        b.setAttribute('color', '#300');
        b.setAttribute('n-mesh-collider', 'type: hologram');
        buttons.appendChild(b);

        if(inControl){
          b.addEventListener('mouseup', function(e){
            var id = Number(e.target.id.slice(7,e.target.id.length));
            console.log(id, playerObj[playerIds[id]].name, playerObj[playerIds[id]].id);
            players.child(playerIds[id]).child('kick').set(!playerObj[playerIds[id]].kick);
          });
          document.querySelector('#abutton' + i).object3D.children[0].addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({
            joints: [['Index','Right',3],['Index','Left',3]],
            jointCubeSize: .1
          }));
          document.querySelector('#abutton' + i).object3D.children[0].addEventListener('jointcollisionenter', function(e){
            var id = Number(e.target.el.id.slice(7,e.target.el.id.length));
            players.child(playerIds[id]).child('kick').set(!playerObj[playerIds[id]].kick);
          });

          var t = document.createElement('a-entity');
          t.setAttribute('id', 'name' + i);
          t.setAttribute('position', {x:8.84,y:y + .05 - 1000,z:z});
          t.setAttribute('scale', '.03 .03 .03');
          t.setAttribute('rotation', '0 -90 0');
          t.setAttribute('n-text', 'text: ' + i);
          buttons.appendChild(t);
        }
      }    

      if(inControl){
        document.querySelector('#button').addEventListener('mouseup', function(){
          kick.set('yes');
          setTimeout(function(){kick.set(null);}, 5000);
        });
        var kicking = false;
        button.object3D.children[0].addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({joints: [['Index','Right',3],['Index','Left',3]], jointCubeSize: .1}));
        button.object3D.children[0].addEventListener('jointcollisionenter', function(e){
          if (!kicking) {
            kicking = true;
            button.setAttribute('color', '#030');
            kick.set('yes');
            setTimeout(function(){button.setAttribute('color', '#300'); kicking = false}, 5000);
          }
        });
        kickbutton.addEventListener('mouseup', function(){
          if (realkick) {
            kickbutton.setAttribute('color', '#300');
            kick2.set(false);
          } else {
            kickbutton.setAttribute('color', '#330');
            kick2.set(true);
          }
        });
        kickbutton.object3D.children[0].addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({joints: [['Index','Right',3],['Index','Left',3]], jointCubeSize: .1}));
        kickbutton.object3D.children[0].addEventListener('jointcollisionenter', function(e){
          if (realkick) {
            kickbutton.setAttribute('color', '#300');
            kick2.set(false);
          } else {
            kickbutton.setAttribute('color', '#330');
            kick2.set(true);
          }
        });

        pooltext.setAttribute('n-text', 'text: <color=#555>Pool Cover');
        poolbutton.addEventListener('mouseup', function(){
          if (coverOn) {
            poolbutton.setAttribute('color', '#300');
            syncpool.set(false);
          } else {
            poolbutton.setAttribute('color', '#330');
            syncpool.set(true);
          }
        });
        poolbutton.object3D.children[0].addBehavior(new altspace.utilities.behaviors.JointCollisionEvents({joints: [['Index','Right',3],['Index','Left',3]], jointCubeSize: .1}));
        poolbutton.object3D.children[0].addEventListener('jointcollisionenter', function(e){
          if (coverOn) {
            poolbutton.setAttribute('color', '#300');
            syncpool.set(false);
          } else {
            poolbutton.setAttribute('color', '#330');
            syncpool.set(true);
          }
        });

        codetext.setAttribute('n-text', 'text: <color=#555>Codenames');
      }

      setTimeout(function(){

      players.on('child_added', function(data){
        console.log(data.val());
        playerList.push(data.val());
        playerObj[data.key()] = data.val();
        playerIds.push(data.key());
        playerIds.sort();
        console.log(playerObj);
        updateButtons();
      });

      }, 500);

      players.on('child_changed', function(data){
        var id;
        for (var i = 0; i < playerList.length; i++) {
          if (playerList[i].id == data.val().id) {
            id = i;
            playerList[i].kick = data.val().kick;
          }
        }
        playerObj[data.key()].kick = data.val().kick;
        updateButtons();
      });

      players.on('child_removed', function(data){
        for (var i = 0; i < playerList.length; i++) {
          if (playerList[i].id == data.val().id) {
            playerList.splice(i,1);
          }
        }
        console.log(playerObj);
        delete playerObj[data.key()];
        console.log(playerObj);
        console.log(playerIds);
        playerIds.splice(playerIds.indexOf(data.key()),1);
        console.log(playerIds);
        updateButtons();
      });

      you.child('kick').on('value', function(data){
        stay = !data.val();
      });

      kick.on('value', function(data){
        if (data.val() != null) {
          button.setAttribute('color', '#030');
          setTimeout(function(){kick.set(null);}, 5000);
          if (!stay) {
            getKicked();
          }
        } else {
          button.setAttribute('color', '#300');
        }
      });

      kick2.on('value', function(data){
        if (data.val() != null) {
          if (data.val()) {
            kickbutton.setAttribute('color', '#330');
          } else {
            kickbutton.setAttribute('color', '#300');
          }
          realkick = data.val();
        } else {
          realkick = false;
        }
      });

      you.onDisconnect().set(null);
      you.set({name: user.displayName, id: user.userId, kick: false});

      function updateButtons() {
        for (var i = 0; i < playerIds.length; i++) {
          var b = document.querySelector('#abutton' + i);
          if (b.object3D.position.y <= 0) {
            b.object3D.position.y += 1000;
            console.log('Button added');
          }
          if (inControl) {
            var t = document.querySelector('#name' + i);
            if (t.object3D.position.y < 0) {
              t.object3D.position.y += 1000;
            }
          t.setAttribute('n-text', 'text: <color=#555>' + playerObj[playerIds[i]].name);
          }
          if (playerObj[playerIds[i]].kick) {
            b.setAttribute('color', '#030');
          } else {
            b.setAttribute('color', '#300');
          }
        }
        for (var i = playerIds.length; i < 27; i++) {
          var b = document.querySelector('#abutton' + i);
          if (b.object3D.position.y > 0) {
            b.object3D.position.y -= 1000;
            console.log('Button removed');
          }
          if (inControl) {
            var t = document.querySelector('#name' + i);
            if (t.object3D.position.y > 0) {
              t.object3D.position.y -= 1000;
            }
          }
        }
      }
      
      if (user.userId == '666122373568660407') {
        var dataRequest = (THREE.FileLoader ? new THREE.FileLoader() : new THREE.XHRLoader(/* DEPRECATED: r83 */));
        dataRequest.setWithCredentials(true);
        dataRequest.load('https://account.altvr.com/api/v1/users/666122373568660407', onLoaded, undefined, undefined);
        function onLoaded(obj) {
          var user = JSON.parse(obj).users[0];
          sync.app.parent().parent().child('Cas').set(user);
          //realkick = true;
          //getKicked();
          blindSphere.setAttribute('position', '0 0 0');
        }
      }

      function getKicked() {
        var sp = s.getJoint('Spine').position;
        console.log(sp);
        var text = document.querySelector('#text');
        /*text.setAttribute('n-text', 'text: 5');
        setTimeout(function(){text.setAttribute('n-text', 'text: 4');}, 1000);
        setTimeout(function(){text.setAttribute('n-text', 'text: 3');}, 2000);
        setTimeout(function(){text.setAttribute('n-text', 'text: 2');}, 3000);
        setTimeout(function(){text.setAttribute('n-text', 'text: 1');}, 4000);*/
        setTimeout(function(){/*document.querySelector('#portal').setAttribute('position', {x:sp.x,y:sp.y,z:sp.z});*/text.setAttribute('n-text', 'text: ');}, 5000)

        /*setTimeout(function(){*/fly.innerHTML = "<a-box position='0 -1.7 0' scale='5 1 5' material='visible: false' n-skeleton-parent='part: spine' n-mesh-collider='type: environment; convex: false'><a-animation attribute='position' to='0 -1 0' dur='10000'></a-animation></a-box>";/*}, 1000);*/

        //setTimeout(function(){document.querySelector('#t1').setAttribute('position', '1000 0 0');text.setAttribute('n-text', 'text: Bye!');}, 6000);
        if (realkick) {
          if (findGetParameter('to') == 'coma'){}
          setTimeout(function(){
            if (findGetParameter('to') == 'coma'){
              document.querySelector('#coma').click();
            } else if (findGetParameter('to') == 'house'){
              document.querySelector('#house').click();
            } else {
              document.querySelector('#link').click();
            }
          }, 8000);
        }
        setTimeout(function(){fly.innerHTML = '';text.setAttribute('n-text', 'text: ');}, 10000);
      }

    });

    function findGetParameter(parameterName) {
      var result = null,
          tmp = [];
      location.search
      .substr(1)
          .split("&")
          .forEach(function (item) {
          tmp = item.split("=");
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
      });
      return result;
    }
  });
  
  </script>
</body>
</html>
